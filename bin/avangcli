#!/usr/bin/env node

import { spawn } from "child_process"
import { readFileSync } from "fs"
import { dirname, join } from "path"
import { fileURLToPath } from "url"
import yargs from "yargs"
import { hideBin } from "yargs/helpers"

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
const rootDir = join(__dirname, "..")

const packageJson = JSON.parse(
  readFileSync(join(rootDir, "package.json"), "utf-8")
)
const version = packageJson.version

function launchFrontendCli(args) {
  const frontendCliPath = join(rootDir, "frontend-cli", "index.js")

  const frontendCli = spawn("node", [frontendCliPath, ...args], {
    stdio: "inherit"
  })

  frontendCli.on("exit", (code) => {
    process.exit(code || 0)
  })

  frontendCli.on("error", (err) => {
    console.error("Failed to launch frontend CLI:", err)
    process.exit(1)
  })
}

yargs(hideBin(process.argv))
  .scriptName("avangcli")
  .usage("Usage: $0 <command> [options]")
  .command(
    "init [project-name]",
    "Initialize a new Next.js project",
    (yargs) => {
      return yargs
        .positional("project-name", {
          describe: "Name of the project to create",
          type: "string"
        })
        .option("package-manager", {
          alias: "pm",
          describe: "Package manager to use (npm, yarn, pnpm, bun)",
          type: "string",
          choices: ["npm", "yarn", "pnpm", "bun"]
        })
        .option("tailwind", {
          alias: "t",
          describe: "Use Tailwind CSS",
          type: "boolean"
        })
        .option("linter-formatter", {
          alias: "lf",
          describe: "Linter and formatter setup",
          type: "string",
          choices: ["eslint-prettier", "biome", "none"]
        })
        .option("docker", {
          alias: "d",
          describe: "Docker configuration",
          type: "string",
          choices: ["dev", "prod", "both", "none"]
        })
        .option("ui-library", {
          alias: "ui",
          describe: "UI component library",
          type: "string",
          choices: ["mui", "shadcn", "heroui", "none"]
        })
        .option("git-setup", {
          alias: "git",
          describe: "Setup Git with Commitizen, Commitlint, Husky & Lint-staged",
          type: "boolean"
        })
        .option("openapi-docs-dir", {
          describe: "OpenAPI docs directory for generate command",
          type: "string"
        })
        .option("openapi-output-dir", {
          describe: "Output directory for generated TypeScript clients",
          type: "string"
        })
        .help(false)
        .version(false)
    },
    (_argv) => {
      launchFrontendCli(process.argv.slice(2))
    }
  )
  .command(
    "module <module-name>",
    "Generate a new module in an existing Next.js application",
    (yargs) => {
      return yargs.help(false).version(false)
    },
    (_argv) => {
      launchFrontendCli(process.argv.slice(2))
    }
  )
  .command(
    "config",
    "Regenerate avangclirc.json based on current project configuration",
    (yargs) => {
      return yargs.help(false).version(false)
    },
    (_argv) => {
      launchFrontendCli(process.argv.slice(2))
    }
  )
  .command(
    "generate",
    "Generate TypeScript clients from OpenAPI specifications",
    (yargs) => {
      return yargs
        .option("docs-dir", {
          alias: "d",
          describe: "Directory containing OpenAPI JSON files",
          type: "string"
        })
        .option("output-dir", {
          alias: "o",
          describe: "Output directory for generated clients",
          type: "string"
        })
        .help(false)
        .version(false)
    },
    (_argv) => {
      launchFrontendCli(process.argv.slice(2))
    }
  )
  .command(
    "ui-library [library]",
    "Add a UI component library to your Next.js project",
    (yargs) => {
      return yargs
        .positional("library", {
          describe: "UI library to install (mui, shadcn, heroui)",
          type: "string",
          choices: ["mui", "shadcn", "heroui"]
        })
        .help(false)
        .version(false)
    },
    (_argv) => {
      launchFrontendCli(process.argv.slice(2))
    }
  )
  .demandCommand(1, "You need to specify a command")
  .help("h")
  .alias("h", "help")
  .version(version)
  .alias("v", "version")
  .epilogue("For more information, visit: https://github.com/ClaudiaQueipo/avangcli")
  .parse()
